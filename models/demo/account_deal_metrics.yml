models:
  - name: account_deal_metrics
    meta:
      primary_key: deal_id
      description: >
        Demonstrates the workaround for metrics that need different levels of aggregation.
        This model pre-computes total deals per segment in dbt, so the denominator
        for percentage calculations is always correct, even when grouped by deal-level
        dimensions like plan.

      metrics:
        pct_of_segment_deals:
          type: number
          label: "% of Segment Deals"
          description: >
            Percentage of a segment's deals that belong to this plan.
            The denominator (total_deals_in_segment) is pre-computed in dbt
            and is NOT affected by the plan dimension.
          format: percent
          sql: CAST(${unique_deals} AS FLOAT64) / NULLIF(${segment_total_deals}, 0)

    columns:
      - name: account_id
        meta:
          dimension:
            type: string
            hidden: true

      - name: account_name
        meta:
          dimension:
            type: string

      - name: segment
        description: "Market segment (SMB, Midmarket, Enterprise)"
        meta:
          dimension:
            type: string

      - name: industry
        meta:
          dimension:
            type: string

      - name: deal_id
        meta:
          dimension:
            type: string
            hidden: true
          metrics:
            unique_deals:
              type: count_distinct
              description: Number of deals for this plan and segment combination.

      - name: plan
        description: "Deal plan type (Basic, Professional)"
        meta:
          dimension:
            type: string

      - name: stage
        description: "Deal stage (New, Qualified, PoC, Negotiation, Won, Lost)"
        meta:
          dimension:
            type: string

      - name: amount
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            total_deal_amount:
              type: sum
              format: 'usd'

      - name: total_deals_in_segment
        description: >
          Pre-computed total number of deals in this segment, calculated
          independently of the deal plan dimension. This is the DENOMINATOR
          that stays correct regardless of grouping.
        meta:
          dimension:
            type: number
          metrics:
            segment_total_deals:
              type: max
              description: >
                Total deals in this segment (pre-computed in dbt).
                Use this as the denominator for percentage calculations.
                It is NOT affected by the plan or stage dimensions.
