models:
  - name: account_deal_metrics
    meta:
      primary_key: deal_id
      description: >
        Demonstrates the workaround for metrics that need different levels of aggregation.
        This model pre-computes total accounts per segment in dbt, so the denominator
        for percentage calculations is always correct — even when grouped by deal-level
        dimensions like plan.

      metrics:
        pct_accounts_with_won_deals:
          type: number
          label: "% Accounts with Won Deals"
          description: >
            Percentage of accounts in a segment that have Won deals.
            The denominator (total_accounts_in_segment) is pre-computed in dbt
            and is NOT affected by the plan dimension.
          format: percent
          sql: ${unique_accounts_with_won_deals} / NULLIF(${total_accounts_in_segment}, 0)

    columns:
      - name: account_id
        meta:
          dimension:
            type: string
            hidden: true
          metrics:
            unique_accounts_with_deals:
              type: count_distinct
              description: >
                Accounts that have at least one deal for the selected plan.
                This is the NUMERATOR — it correctly varies by plan.
            unique_accounts_with_won_deals:
              type: count_distinct
              description: >
                Accounts that have at least one Won deal for the selected plan.
              filters:
                - stage: 'Won'

      - name: account_name
        meta:
          dimension:
            type: string

      - name: segment
        description: "Market segment (SMB, Midmarket, Enterprise)"
        meta:
          dimension:
            type: string

      - name: industry
        meta:
          dimension:
            type: string

      - name: deal_id
        meta:
          dimension:
            type: string
            hidden: true
          metrics:
            unique_deals:
              type: count_distinct

      - name: plan
        description: "Deal plan type (Basic, Professional)"
        meta:
          dimension:
            type: string

      - name: stage
        description: "Deal stage (New, Qualified, PoC, Negotiation, Won, Lost)"
        meta:
          dimension:
            type: string

      - name: amount
        meta:
          dimension:
            type: number
            hidden: true
          metrics:
            total_deal_amount:
              type: sum
              format: 'usd'

      - name: total_accounts_in_segment
        description: >
          Pre-computed total number of accounts in this segment, calculated
          independently of the deal plan dimension. This is the DENOMINATOR
          that stays correct regardless of grouping.
        meta:
          dimension:
            type: number
          metrics:
            # Use max since all rows in the same segment have the same value
            total_accounts_in_segment:
              type: max
              description: >
                Total accounts in this segment (pre-computed in dbt).
                Use this as the denominator for percentage calculations.
                It is NOT affected by the plan or stage dimensions.
