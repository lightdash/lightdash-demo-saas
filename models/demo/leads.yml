version: 2
models:
  - name: leads
    meta:
      required_attributes:
        is_admin_saas_demo: 'true'
      primary_key: lead_id
      ai_hint: |
          This is a leads table containing lead information and derived facts.
          Use this for lead or sales stage funnel reporting, marketing efficiency analysis, and sdr reporting.

      joins:
        - join: users
          sql_on: ${leads.user_id} = ${users.user_id}
          type: left
          relationship: many-to-one
        - join: deals
          sql_on: ${leads.deal_id} = ${deals.deal_id}   
          type: left
          relationship: many-to-one

      parameters:
        utm_toggle:
          label: "Channel/Campaign/Medium"
          description: "Filter leads by marketing channel or campaign"
          options:
                - "lead_source"
                - "utm_medium"
                - "campaign_name"
          default: "channel"
          multiple: false

      metrics:
        conversion_rate:
          type: number
          description: "Percentage of leads that converted"
          sql: "(${converted_leads} / NULLIF(${unique_lead_count}, 0))"
          format: percent
          groups: ['Lead Performance']
          spotlight:
            visibility: show
            categories:
              - leads
          ai_hint: |
            Show this metric to evaluate how well marketing channels and SDRs are converting leads into opportunities.
            Use with time filters to measure conversion trend over time and compare cohorts.
        avg_days_to_convert:
          type: average
          description: "Average number of days it takes for a lead to convert"
          sql: DATE_DIFF(${converted_at}, ${created_at}, DAY)
          format: '0.0'
          groups: ['Lead Performance']
          spotlight:
            visibility: show
            categories:
              - leads
          ai_hint: |
            Use this to understand funnel velocity â€” lower values indicate faster conversions.
            Compare by `sdr` and `lead_source` to identify faster converting channels or reps.
        cost_per_conversion:
          type: number
          description: "Average cost per converted lead"
          sql: SAFE_DIVIDE(${total_lead_cost}, ${converted_leads})
          format: '$#,##0.00'
          groups: ['Lead Performance']
          spotlight:
            visibility: show
            categories:
              - leads

    columns:
      - name: lead_id
        description: "The unique identifier for a lead"
        meta:
          dimension:
            type: string
          metrics:
            unique_lead_count:
              type: count_distinct
              description: "The unique number of leads based on distinct lead IDs"
              groups: ['Lead Counts']
              spotlight:
                visibility: show
                categories:
                  - leads
                  - marketing
              ai_hint: |
                Unique lead count for marketing/sales reporting.
                Use this for customer aquisition analysis and lead funnel reporting.
            open_leads:
              type: count_distinct
              groups: ['Lead Counts']
              description: Count unique leads with status = 'Open'
              filters:
                - lead_status: ['new', 'contacted', 'qualified']
              spotlight:
                visibility: show
                categories:
                  - leads
                  - marketing
            contacted_leads:
              type: count_distinct
              groups: ['Lead Counts']
              description: Count unique leads with status = 'Contacted'
              filters:
                - lead_status: 'contacted'
              spotlight:
                visibility: show
                categories:
                  - leads
                  - marketing
            qualified_leads:
              type: count_distinct
              groups: ['Lead Counts']
              description: Count unique leads with status = 'Contacted'
              filters:
                - lead_status: 'qualified'
              spotlight:
                visibility: show
                categories:
                  - leads
                  - marketing
            converted_leads:
              type: count_distinct
              groups: ['Lead Counts']
              description: Count unique leads with status = 'Converted'
              filters:
                - lead_status: 'converted'
              spotlight:
                visibility: show
                categories:
                  - leads
                  - marketing
            disqualified_leads:
              type: count_distinct
              groups: ['Lead Counts']
              description: Count unique leads with status = 'Disqulified'
              filters:
                - lead_status: 'disqualified'
              spotlight:
                visibility: show
                categories:
                  - leads
                  - marketing
      - name: user_id
        description: "The identifier for a user"
        meta:
          dimension:
            type: string
      - name: sdr
        description: "The Sales Development Representative assigned to the lead"
        meta:
          dimension:
            type: string
      - name: industry
        description: "The industry associated with the lead's company"
        meta:
          dimension:
            type: string
      - name: deal_id
        description: "The identifier for a deal"
        meta:
          dimension:
            type: string
          metrics:
            unique_deal_count:
              type: count_distinct
              description: "The unique number of deals"
              groups: ['Counts']
              spotlight:
                visibility: show
                categories:
                  - sales
      - name: lead_source
        description: "The name of the source which drew in the lead"
        meta:
          dimension:
            type: string
          additional_dimensions:
            is_paid_marketing:
              type: boolean
              sql: IF(LOWER(lead_source) IN ('google ads', 'facebook ads', 'linkedin'), TRUE, FALSE)
            utm_toggle:
              label: "Channel/Campaign/Medium"
              description: "Filter leads by marketing channel or campaign"
              type: string
              sql: |
                case 
                  when ${lightdash.parameters.leads.utm_toggle} = 'lead_source' then ${lead_source}
                  when ${lightdash.parameters.leads.utm_toggle} = 'utm_medium' then ${utm_medium}
                  when ${lightdash.parameters.leads.utm_toggle} = 'campaign_name' then ${campaign_name}
                end
            selected_dim: 
              label: Selected dimension
              type: string
              description: The dimension that is currently selected in the utm_toggle parameter
              sql: ${lightdash.parameters.leads.utm_toggle}}
      - name: campaign_name
        description: "Name of the marketing campaign associated with the lead (if available)"
        meta:
          dimension:
            type: string
      - name: utm_medium
        description: "UTM medium used for the lead (e.g., email, cpc, social)"
        meta:
          dimension:
            type: string
      - name: lead_cost
        description: "Cost attributed to acquiring this lead"
        meta:
          dimension:
            type: number
            format: '$#,##0.00'
          metrics:
            total_lead_cost:
              type: sum
              description: "The sum of lead_cost for selected leads"
              format: '$#,##0'
              groups: ['Lead Costs']
              ai_hint: |
                Sum of attributed lead acquisition costs. Useful for calculating CAC and evaluating marketing ROI when joined to `deals.total_amount`.
              spotlight:
                visibility: show
                categories:
                  - leads
                  - marketing
            avg_lead_cost:
              type: average
              description: "The average lead cost for selected leads"
              format: '$#,##0.00'
              groups: ['Lead Costs']
              spotlight:
                visibility: show
                categories:
                  - leads
                  - marketing
      - name: lead_status
        description: "Current status of the lead (e.g., Open, Contacted, Converted, Disqualified)"
        meta:
          dimension:
            type: string
      - name: created_at
        description: "The timestamp at which the lead was created"
        meta:
          dimension:
            type: timestamp
            time_intervals:
              [
                'DAY', 'WEEK', 'MONTH', 'YEAR', 'QUARTER',
                'DAY_OF_MONTH_NUM', 'DAY_OF_YEAR_NUM', 'WEEK_NUM', 'MONTH_NUM',
                'QUARTER_NUM', 'YEAR_NUM', 'HOUR_OF_DAY_NUM',
                'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME'
              ]
      - name: converted_at
        description: "The timestamp at which the lead was converted"
        meta:
          dimension:
            type: timestamp
            time_intervals:
              [
                'DAY', 'WEEK', 'MONTH', 'YEAR', 'QUARTER',
                'DAY_OF_MONTH_NUM', 'DAY_OF_YEAR_NUM', 'WEEK_NUM', 'MONTH_NUM',
                'QUARTER_NUM', 'YEAR_NUM', 'HOUR_OF_DAY_NUM',
                'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME'
              ]
