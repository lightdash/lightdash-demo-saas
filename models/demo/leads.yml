version: 2
models:
  - name: leads
    meta:
      required_attributes:
        is_admin_saas_demo: 'true'
      primary_key: lead_id
      joins:
        - join: users
          sql_on: ${user_id} = ${users.user_id}
          type: left
          relationship: many-to-one
        - join: deals
          sql_on: ${deal_id} = ${deals.deal_id}
          type: left
          relationship: many-to-one
      metrics:
        conversion_rate:
          type: number
          description: "Percentage of leads that converted"
          sql: "(${converted_leads} / NULLIF(${unique_lead_count}, 0))"
          format: percent
          groups: ['Lead Performance']
          spotlight:
            visibility: show
            categories: ['kpi', 'marketing']
        avg_days_to_convert:
          type: average
          description: "Average number of days it takes for a lead to convert"
          sql: DATE_DIFF(${converted_at}, ${created_at}, DAY)
          format: '0.0'
          groups: ['Lead Performance']
          spotlight:
            visibility: show
            categories: ['kpi', 'marketing']
        cost_per_conversion:
          type: number
          description: "Average cost per converted lead"
          sql: SAFE_DIVIDE(${total_lead_cost}, ${converted_leads})
          format: '$#,##0.00'
          groups: ['Lead Performance']
        roi:
          type: number
          description: "Return on marketing spend from converted deals"
          sql: SAFE_DIVIDE(${deals.total_amount}, ${total_lead_cost})
          format: '0.0x'
          groups: ['Funnel Performance']

    columns:
      - name: lead_id
        description: "The unique identifier for a lead"
        meta:
          dimension:
            type: string
          metrics:
            unique_lead_count:
              type: count_distinct
              description: "The unique number of leads based on distinct lead IDs"
              groups: ['Lead Counts']
            open_leads:
              type: count_distinct
              groups: ['Lead Counts']
              description: Count unique leads with status = 'Open'
              filters:
                - lead_status: ['new', 'contacted', 'qualified']
            contacted_leads:
              type: count_distinct
              groups: ['Lead Counts']
              description: Count unique leads with status = 'Contacted'
              filters:
                - lead_status: 'contacted'
            qualified_leads:
              type: count_distinct
              groups: ['Lead Counts']
              description: Count unique leads with status = 'Contacted'
              filters:
                - lead_status: 'qualified'
            converted_leads:
              type: count_distinct
              groups: ['Lead Counts']
              description: Count unique leads with status = 'Converted'
              filters:
                - lead_status: 'converted'
              spotlight:
                visibility: show
                categories:
                  - kpi
                  - marketing
            disqualified_leads:
              type: count_distinct
              groups: ['Lead Counts']
              description: Count unique leads with status = 'Disqulified'
              filters:
                - lead_status: 'disqualified'
              spotlight:
                visibility: show
                categories:
                  - kpi
                  - marketing

      - name: user_id
        description: "The identifier for a user"
        meta:
          dimension:
            type: string

      - name: sdr
        description: "The Sales Development Representative assigned to the lead"
        meta:
          dimension:
            type: string

      - name: industry
        description: "The industry associated with the lead's company"
        meta:
          dimension:
            type: string

      - name: deal_id
        description: "The identifier for a deal"
        meta:
          dimension:
            type: string
          metrics:
            unique_deal_count:
              type: count_distinct
              description: "The unique number of deals"
              groups: ['Counts']

      - name: lead_source
        description: "The name of the source which drew in the lead"
        meta:
          dimension:
            type: string
          additional_dimensions:
            is_paid_marketing:
              type: boolean
              sql: IF(LOWER(lead_source) IN ('google ads', 'facebook ads', 'linkedin'), TRUE, FALSE)

      - name: campaign_name
        description: "Name of the marketing campaign associated with the lead (if available)"
        meta:
          dimension:
            type: string

      - name: utm_medium
        description: "UTM medium used for the lead (e.g., email, cpc, social)"
        meta:
          dimension:
            type: string

      - name: lead_cost
        description: "Cost attributed to acquiring this lead"
        meta:
          dimension:
            type: number
            format: '$#,##0.00'
          metrics:
            total_lead_cost:
              type: sum
              description: "The sum of lead_cost for selected leads"
              format: '$#,##0'
              groups: ['Lead Costs']
            avg_lead_cost:
              type: average
              description: "The average lead cost for selected leads"
              format: '$#,##0.00'
              groups: ['Lead Costs']

      - name: lead_status
        description: "Current status of the lead (e.g., Open, Contacted, Converted, Disqualified)"
        meta:
          dimension:
            type: string

      - name: created_at
        description: "The timestamp at which the lead was created"
        meta:
          dimension:
            type: timestamp
            time_intervals:
              [
                'DAY', 'WEEK', 'MONTH', 'YEAR', 'QUARTER',
                'DAY_OF_MONTH_NUM', 'DAY_OF_YEAR_NUM', 'WEEK_NUM', 'MONTH_NUM',
                'QUARTER_NUM', 'YEAR_NUM', 'HOUR_OF_DAY_NUM',
                'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME'
              ]

      - name: converted_at
        description: "The timestamp at which the lead was converted"
        meta:
          dimension:
            type: timestamp
            time_intervals:
              [
                'DAY', 'WEEK', 'MONTH', 'YEAR', 'QUARTER',
                'DAY_OF_MONTH_NUM', 'DAY_OF_YEAR_NUM', 'WEEK_NUM', 'MONTH_NUM',
                'QUARTER_NUM', 'YEAR_NUM', 'HOUR_OF_DAY_NUM',
                'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME'
              ]
