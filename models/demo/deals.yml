models:
- name: deals
  meta:
    description: All sales deals of any status, pulled from our CRM 
    primary_key: deal_id
    order_fields_by: 'index'
    ai_hint: |
          CloseRate Kevin: This is your primary deals model for analyzing pipeline progression and win/loss performance.
          Use this to measure stage-to-stage conversion (New → Qualified → PoC → Negotiation → Won/Lost), calculate win rates, and identify stalled deals.
          Key dimensions: `stage` (with stages: New, Qualified, PoC, Negotiation, Won, Lost), `created_date` (for cohort analysis).
          Core metrics: `win_rate` (won deals / total deals), stage-specific counts (`new_deals`, `qualified_deals`, `poc_deals`, `negotiation_deals`, `won_deals`, `lost_deals`), `total_amount`, `total_won_amount`.
          Critical for AE performance analysis. Focus on demo-to-close rates (PoC → Negotiation → Won conversion) and identifying aging deals at each stage.
          Default to line charts for trend analysis, with period-over-period comparisons using `created_date` dimensions.

    parameters:
        deal_value_toggle:
          label: "High Value Deal Toggle"
          description: "Filter deals by the amount to see high value deals only"
          options:
                - 500
                - 1000
                - 1500
          default: 1000
          multiple: false

    joins:
      - join: activities
        sql_on: ${deals.deal_id} = ${activities.deal_id}
        type: left
        relationship: one-to-many

  columns:
    - name: deal_id
      description: "The unique identified for a Deal"
      meta:
        dimension:
          type: string
          label: Deal ID
        metrics:
          unique_deals:
            type: count_distinct
            description: Count unique deals based on Account ID (each account can only have one deal)
            spotlight:
              visibility: show
              categories:
                - kpi
                - sales
            ai_hint: |
              CloseRate Kevin: Use `unique_deals` as the denominator for win rate and stage conversion calculations.
              This represents total deal volume. Break down by time period to track pipeline growth or contraction.
          new_deals:
            type: count_distinct
            groups: ['Deal Counts']
            description: Count unique deals based on the Account ID and filter to only deals in the New stage
            filters:
              - stage: 'New'
            spotlight:
              visibility: show
              categories:
                - kpi
                - sales
          qualified_deals:
            type: count_distinct
            groups: ['Deal Counts']
            description: Count unique deals based on the Account ID and filter to only deals in the Qualified stage
            filters:
              - stage: 'Qualified'
          poc_deals:
            type: count_distinct
            groups: ['Deal Counts']
            description: Count unique deals based on the Account ID and filter to only deals in the PoC stage
            filters:
              - stage: 'PoC'
            ai_hint: |
              CloseRate Kevin: Use `poc_deals` to track the "demo" or proof-of-concept stage—critical for demo-to-close analysis.
              Calculate PoC → Won conversion by dividing `won_deals` by `poc_deals`. Monitor aging PoC deals to identify stalled demos.
          negotiation_deals:
            type: count_distinct
            groups: ['Deal Counts']
            description: Count unique deals based on the Account ID and filter to only deals in the Negotiation stage
            filters:
              - stage: 'Negotiation'
          won_deals:
            type: count_distinct
            groups: ['Deal Counts']
            description: Count unique deals based on the Account ID and filter to only deals in the Won stage
            filters:
              - stage: 'Won'
            spotlight:
              visibility: show
              categories:
                - kpi
                - sales
            ai_hint: |
              CloseRate Kevin: Use `won_deals` as the numerator for win rate calculations and stage conversion analysis.
              Track over time to measure sales momentum. Compare against `poc_deals` for demo-to-close performance.
          lost_deals:
            type: count_distinct
            groups: ['Deal Counts']
            description: Count unique deals based on the Account ID and filter to only deals in the Lost stage
            filters:
              - stage: 'Lost'
            spotlight:
              visibility: show
              categories:
                - sales
          win_rate:
            type: number
            description: The percentage of deals that have been won
            format: percent
            sql: ${won_deals} / NULLIF(${unique_deals}, 0)
            spotlight:
              visibility: show
              categories:
                - kpi
            ai_hint: |
              CloseRate Kevin: Use `win_rate` to measure overall deal closure effectiveness (won deals ÷ total deals).
              This is a core KPI for AE performance. Break down by time period (week, month, quarter) to identify trends.
              Compare period-over-period to spot declining win rates early. Pair with `loss_rate` to understand win/loss balance.
            groups: ['Rates & Ratios']
          loss_rate:
            type: number
            format: percent
            sql: ${lost_deals} / NULLIF(${unique_deals}, 0)
            groups: ['Rates & Ratios']
          win_vs_lost_ratio:
            type: number
            round: 2
            sql: ${lost_deals} / NULLIF(${won_deals}, 0)
            groups: ['Rates & Ratios']


    - name: created_date
      description: "The date the deal was created"
      meta:
        dimension:
          type: date
          time_intervals: ['DAY', 'WEEK', 'MONTH', 'MONTH_NAME', 'YEAR', 'QUARTER']
    - name: account_id
      description: "The Account ID from our database"
      meta:
        dimension:
          type: number
          hidden: true
    - name: is_high_value_deal
      meta:
        dimension:
          type: boolean
          sql: ${deals.amount} >= CAST(${lightdash.parameters.deal_value_toggle} AS NUMERIC)
    - name: stage
      description: "The deal stage (New, Qualified, PoC, Negotiation, Won, Lost)"
      meta:
        dimension:
          type: string
        ai_hint: |
          CloseRate Kevin: Use `stage` to track deals through the sales funnel: New → Qualified → PoC → Negotiation → Won/Lost.
          Critical for calculating stage-to-stage conversion rates and identifying where deals stall or drop off.
          Filter by specific stages to analyze aging deals (e.g., deals stuck in Negotiation). Use `stage_order` for proper funnel sequencing.
        additional_dimensions:
          stage_order:
            type: number
            sql: case
              when stage = 'New' then 1
              when stage = 'Qualified' then 2
              when stage = 'PoC' then 3
              when stage = 'Negotiation' then 4
              when stage = 'Won' then 5
              when stage = 'Lost' then 6
              end
    - name: plan
      description: "The plan the prospect is interested in (Basic or Professional)"
      meta:
        dimension:
          type: string
          colors:
            'Basic': "#C0C0C0"
            'Professional': "#FFD700"
    - name: seats
      description: "The number of seats they are purchasing"
      meta:
        dimension:
          type: number
          hidden: true
        metrics:
          total_seats:
            type: sum
            description: The sum of seats for selected deals
            groups: ['Seats']
          average_seats:
            type: average
            round: 0
            groups: ['Seats']
            description: The average number of seats per deal for selected deals
