version: 2
models:
  - name: multiple_1_to_many_joins
    meta:
      sql_filter: ${lightdash.attributes.is_admin_saas_demo} = 'true' or segment !=
        'Enterprise'
      joins:
        # üö® INTENTIONAL METRICS INFLATION DEMO üö®
        # These joins will cause metrics inflation - perfect for demonstrating the problem!

        - join: fanouts_deals
          sql_on: ${multiple_1_to_many_joins.account_id} = ${fanouts_deals.account_id}
          type: left
          fields:
            [
              unique_deals,
              stage,
              amount,
              inflated_total_deal_value,
              inflated_average_deal_value
            ]

        - join: fanouts_users
          sql_on: ${multiple_1_to_many_joins.account_id} = ${fanouts_users.account_id}
          type: left
          fields: [ user_id, unique_users_INFLATED, job_title, is_marketing_opted_in ]

    columns:
      - name: account_id
        description: "The Account ID from our database"
        meta:
          dimension:
            type: string
          metrics:
            unique_accounts:
              type: count_distinct
              label: "‚úÖ FANOUT SAFE Unique Account Count"
              description: "‚úÖ CORRECT: Uses count_distinct so won't inflate"

            # üö® INFLATION DEMO METRICS üö®
            inflated_account_count:
              type: count
              label: "üö® INFLATED Account Count"
              description: "‚ùå WRONG: Uses COUNT instead of COUNT_DISTINCT - will inflate based on the grain of the data"

      - name: account_name
        description: "Name of this company account"
        meta:
          dimension:
            type: string

      - name: industry
        description: "Stock market industry for this account"
        meta:
          dimension:
            type: string
          metrics:
            unique_industry_count:
              type: count_distinct
              label: "‚úÖ SAFE Unique Industry Count"
              description: "‚úÖ CORRECT: Uses count_distinct so won't inflate regardless of the
                grain of the data"
            inflated_industry_count:
              type: count
              label: "üö® ALWAYS INFLATED Industry Count"
              description: "‚ùå WRONG: Uses COUNT instead of COUNT_DISTINCT - will always return
                inflated count because multiple accounts can fall into the same
                industry."


      - name: segment
        description: "The market Segment for this account (SMB, Midmarket, Enterprise)"
        meta:
          dimension:
            type: string
          metrics:
            unique_segment_count:
              type: count_distinct
              label: "‚úÖ SAFE Unique Segment Count"
              description: "‚úÖ CORRECT: Uses count_distinct so won't inflate regardless of the
                grain of the data."
            inflated_segment_count:
              type: count
              label: "üö® ALWAYS INFLATED Segment Count"
              description: "‚ùå WRONG: Uses COUNT instead of COUNT_DISTINCT - will always return
                inflated count because multiple accounts can fall into the same
                segment."

