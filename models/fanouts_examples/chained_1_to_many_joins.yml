version: 2
models:
  - name: chained_1_to_many_joins
    description: |
      This model demonstrates vhained or sequential 1-to-many joins. 
      - "Accounts" have many "users" and each user has many "tracks" (events).
      This means when these tables are joined together, each account record will be multiplied by the number of users and then by the number of tracks for each user.
      users will be multiplied by the number of tracks, but track will not be inflated. 

    meta:
      sql_filter: ${lightdash.attributes.is_admin_saas_demo} = 'true' or segment !=
        'Enterprise'
      joins:
        # üö® INTENTIONAL METRICS INFLATION DEMO üö®
        # These joins will cause metrics inflation - perfect for demonstrating the problem!

        - join: fanouts_users
          sql_on: ${chained_1_to_many_joins.account_id} = ${fanouts_users.account_id}
          type: left
          fields: [ user_id, unique_users_INFLATED, job_title, is_marketing_opted_in ]

        - join: fanouts_tracks
          sql_on: ${fanouts_users.user_id} = ${fanouts_tracks.user_id}
          type: left
          fields: [ unique_events_INFLATED, event_name, timestamp, event_id ]
          # ‚ö†Ô∏è This creates the triple join: accounts ‚Üí users ‚Üí tracks
          # Combined with the deals join, this will cause massive inflation!

    columns:
      - name: account_id
        description: "The Account ID from our database"
        meta:
          dimension:
            type: string
            urls:
              - label: 'Open in CRM'
                url: https://demo_saas.com/example/account/${ value.raw }
          metrics:
            unique_accounts:
              type: count_distinct
              label: "‚úÖ Unique Account Count"
              description: "‚úÖ CORRECT: Uses count_distinct so won't inflate"

            # üö® INFLATION DEMO METRICS üö®
            inflated_account_count:
              type: count
              label: "üö® INFLATED Account Count"
              description: "‚ùå WRONG: Uses COUNT instead of COUNT_DISTINCT - will inflate based
                on deals√óusers√óevents"

      - name: account_name
        description: "Name of this company account"
        meta:
          dimension:
            type: string

      - name: industry
        description: "Stock market industry for this account"
        meta:
          dimension:
            type: string

      - name: segment
        description: "The market Segment for this account (SMB, Midmarket, Enterprise)"
        meta:
          dimension:
            type: string
